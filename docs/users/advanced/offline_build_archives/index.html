<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-users/advanced/offline_build_archives">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">Offline build archives | Buck2</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://buck2.build/docs/users/advanced/offline_build_archives/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Offline build archives | Buck2"><meta data-rh="true" name="description" content="Buck2 has the capability of producing so-called &quot;offline build archives&quot;. These archives are Antlir OS images which contain every input necessary to build a buck target (or fbpkg.builder target), including:"><meta data-rh="true" property="og:description" content="Buck2 has the capability of producing so-called &quot;offline build archives&quot;. These archives are Antlir OS images which contain every input necessary to build a buck target (or fbpkg.builder target), including:"><link data-rh="true" rel="icon" href="/img/logo.png"><link data-rh="true" rel="canonical" href="https://buck2.build/docs/users/advanced/offline_build_archives/"><link data-rh="true" rel="alternate" href="https://buck2.build/docs/users/advanced/offline_build_archives/" hreflang="en"><link data-rh="true" rel="alternate" href="https://buck2.build/docs/users/advanced/offline_build_archives/" hreflang="x-default"><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-GEGGHE39PE"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-GEGGHE39PE",{anonymize_ip:!0})</script><link rel="stylesheet" href="/assets/css/styles.96950b1b.css">
<link rel="preload" href="/assets/js/runtime~main.2dd65051.js" as="script">
<link rel="preload" href="/assets/js/main.e0147cf1.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script>
<div style="display: none; text-align: center; background-color: white; color: black;" id="internaldocs-banner"></div><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Buck2</b></a><a class="navbar__item navbar__link" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/docs/api/rules/">Rules</a><a class="navbar__item navbar__link" href="/docs/api/">API</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/buck2" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><main class="docMainContainer_gTbr docMainContainerEnhanced_Uz_u"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Offline build archives</h1></header><p>Buck2 has the capability of producing so-called &quot;offline build archives&quot;. These archives are <a href="https://www.internalfb.com/intern/staticdocs/antlir/" target="_blank" rel="noopener noreferrer">Antlir</a> OS images which contain <em>every</em> input necessary to build a buck target (or <a href="https://www.internalfb.com/intern/wiki/Fbpkg/fbpkg.builder/" target="_blank" rel="noopener noreferrer">fbpkg.builder</a> target), including:</p><ul><li>Source files</li><li><a href="https://www.internalfb.com/intern/wiki/Gvfs/" target="_blank" rel="noopener noreferrer">gvfs</a> artifacts</li><li><a href="https://www.internalfb.com/intern/wiki/DotSlash/" target="_blank" rel="noopener noreferrer">Dotslash</a> executables; these are prefetched and cached in the resulting OS image.</li><li>Buckconfig files from inside and outside the repository</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-build-an-image">How to build an image<a href="#how-to-build-an-image" class="hash-link" aria-label="Direct link to How to build an image" title="Direct link to How to build an image">​</a></h2><p>Offline build archives are primarily centered around producing OS images in which you can build an fbpkg in a fully-offline, low-Meta-dependency environment.</p><p>In order to build an image, you need to add a new rule definition along side your <code>fbpkg.builder</code> target. Assume you have a service + <code>fbpkg.builder</code> definition like so:</p><div class="language-[python] codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-[python] codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">load(&quot;@fbcode_macros//build_defs:cpp_binary.bzl&quot;, &quot;cpp_binary&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Import experimental fbpkg.builder using native buck2 rules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">load(&quot;//fbpkg:fbpkg.bzl&quot;, &quot;fbpkg&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cpp_binary(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name = &quot;my_service&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    srcs = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;main.cpp&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    deps = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;//some/dep:one&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;//another/dep:two&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fbpkg.builder(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name = &quot;my.service&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    buck_opts = fbpkg.buck_opts(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mode = &quot;opt-clang-thinlto&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    path_actions = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;my_service&quot;: &quot;:my_service&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Add a new rule using the <code>offline_builder</code> rule type:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">fbpkg.offline_builder(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name = &quot;my.service-offline&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fbpkg = &quot;:my.service&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The output of <code>//:my.service-offline</code> will be an Antlir container that itself can be packaged up in an fbpkg and shipped elsewhere.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="building-inside-the-image">Building inside the image<a href="#building-inside-the-image" class="hash-link" aria-label="Direct link to Building inside the image" title="Direct link to Building inside the image">​</a></h2><p>The OS image will contain all input files necessary to produce the desired output artifact(s) in a no-network, low-dependency environment.</p><p>To test out a build on your devserver and ensure you <em>can</em> actually produce the output you expect, you can materialize the container in a separate location and enter with with <code>systemd-nspawn</code>:</p><div class="language-[bash] codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-[bash] codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Use Antlir&#x27;s special `=container` rule to generate the container locally.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ buck2 run //my/service:my.service-offline=container -- --snapshot-into ~/local/my_service_offline</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Enter the container as the build user with no network, you will need root access</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo systemd-nspawn -D ~/local/my_service_offline --register=no --user facebook --private-network</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[facebook@my_service_offline ~]$ ls -l</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">total 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x 1 facebook users   16 Jul 20 10:13 dotslash_cache</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x 1 facebook users 2142 Jul 20 10:28 fbsource</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This drops you into the container as the <code>facebook</code> service user. This user has various settings and configurations configured on login for buck2 and the new <code>fbpkg-build</code> entrypoint to work offline by default with no extra flags or configuration required.</p><p>There&#x27;s a &quot;checkout&quot; of fbsource at <code>/home/facebook</code> (not a real source code repository, but enough to get builds working), as well as a cached dotslash directory with prefetched executables.</p><p>Inside the fbsource repository are one or more shell scripts to make it easier to perform offline builds:</p><div class="language-[bash] codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-[bash] codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[facebook@my_service_offline fbsource]$ ls -l *.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x 1 facebook users 167 Jul 20 10:07 build_fbpkg_my_service.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[facebook@my_service_offline fbsource]$ cat build_fbpkg_my_service.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exec fbpkg-build --offline --build-local --no-publish fbcode//my/service:my.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[facebook@my_service_offline fbsource]$ ./build_fbpkg_my_service.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-08-08T11:58:01.709968604-07:00  INFO registry_build_utils::build_utils: Using repo found at cwd: /home/facebook/fbsource</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Buck UI: https://www.internalfb.com/buck2/1dbe44a6-2089-46b5-b5fe-83ba82facf69</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Jobs completed: 78265. Time elapsed: 50.2s.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Cache hits: 0%. Commands: 18 (cached: 0, remote: 0, local: 18)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BUILD SUCCEEDED</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-08-08T18:59:00.958700Z  WARN buck2_client_ctx::cleanup_ctx: Async cleanup step &#x27;sending invocation to Scribe&#x27; took 3.535555792s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;x86_64&quot;: &quot;/home/facebook/fbsource/buck-out/v2/gen/fbcode/29146bce1651974e/path/to/my_service_offline/__my_service_offline__/tree&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p>NOTE: today, this only produces a tree of artifacts that represents <strong>uncompressed</strong> fbpkg contents. In the future, this will be updated to produce a fully compressed fbpkg that can be handed off to tupperware. The script above will print out the location of the built fbpkg</p></blockquote><h2 class="anchor anchorWithStickyNavbar_LWe7" id="copy-built-package-out-of-the-container">Copy built package out of the container<a href="#copy-built-package-out-of-the-container" class="hash-link" aria-label="Direct link to Copy built package out of the container" title="Direct link to Copy built package out of the container">​</a></h2><p>You can access the files inside the container, from your dev server, you can cp the generated fbpkg out as root. The path will be the image base path (the path you pass through --snapshot-into when built the image) + path inside container (the output of the build script), in our case it is shown below</p><div class="language-[bash] codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-[bash] codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[yourunix@devvm4242.vll0 /]$ ls ~/local/my_service_offline/home/facebook/fbsource/buck-out/v2/gen/fbcode/29146bce1651974e/path/to/my_service_offline/__my_service_offline__/tree</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server.par</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[yourunix@devvm4242.vll0 /]$ sudo cp ~/local/my_service_offline/home/facebook/fbsource/buck-out/v2/gen/fbcode/29146bce1651974e/path/to/my_service_offline/__my_service_offline__/tree/server.par /tmp/your_test_dir</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="additional-build-modes">Additional build modes<a href="#additional-build-modes" class="hash-link" aria-label="Direct link to Additional build modes" title="Direct link to Additional build modes">​</a></h2><p>Iterating by building a full fbpkg can be slow, particularly if the service is built with very optimized but slow modes like <code>opt-clang-thinlto</code>. Instead, you can add additional modes in which we&#x27;ll instrument a build and other inputs and configurations into the final container:</p><div class="language-[bash] codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-[bash] codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">fbpkg.offline_builder(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name = &quot;my.service-offline&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fbpkg = &quot;:my.service&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    additional_modes = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;fbcode/mode/opt&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;fbcode/mode/dev&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This results in a new shell script at the root of the container fbsource repository, one for each mode:</p><div class="language-[bash] codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-[bash] codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[facebook@my_service_offline fbsource]$ ls -l *.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x 1 facebook users 167 Jul 20 10:07 build_fbpkg_my_service.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x 1 facebook users 123 Jul 20 10:07 build_fbpkg_my_service_targets_mode-opt.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x 1 facebook users 123 Jul 20 10:07 build_fbpkg_my_service_targets_mode-dev.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[facebook@my_service_offline fbsource]$ cat build_my_service_targets_mode-opt.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exec buck2 build @fbsource//fbcode/mode/opt fbcode//my/service:my_service</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>These shell scripts by default build all targets specified in the <code>fbpkg.builder</code> target, but you can also invoke the <code>buck2 build</code> command accordingly.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="implementation-details">Implementation details<a href="#implementation-details" class="hash-link" aria-label="Direct link to Implementation details" title="Direct link to Implementation details">​</a></h2><p>Several environment variables must be set to perform fully-offline builds. These are all set in user-level <code>.bash_profile</code> scripts (which take effect on login):</p><ul><li><code>BUCK_OFFLINE_BUILD</code> must be set; this indicates to buck2 that it should only perform <em>local execution</em> and disable talking to the RE cache layer. Support is also built into <code>fbpkg-build</code> to use a fake fbpkg uuid and build token rather than allocating one from the fbpkg frontend service.</li><li><code>DOTSLASH_CACHE</code> is set to <code>/home/facebook/dotslash_cache</code>. This tells dotslash to look in this directory for prefetched dotslash executables.</li></ul><p>There are also several buckconfigs that must be set to get buck2 working fully-offline:</p><ul><li><code>buck2.file_watcher = notify</code> disables watchman; we don&#x27;t need watchman during an offline build</li><li><code>buck2.use_network_action_output_cache = true</code> tells buck2 to use precached action outputs from <code>ctx.actions.download_file</code> to e.g. perform a HEAD request to figure out if a file needs to be redownloaded during the build. These action outputs are cached in <code>fbsource/buck-out/v2/offline-cache</code>.</li></ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#how-to-build-an-image" class="table-of-contents__link toc-highlight">How to build an image</a></li><li><a href="#building-inside-the-image" class="table-of-contents__link toc-highlight">Building inside the image</a></li><li><a href="#copy-built-package-out-of-the-container" class="table-of-contents__link toc-highlight">Copy built package out of the container</a></li><li><a href="#additional-build-modes" class="table-of-contents__link toc-highlight">Additional build modes</a></li><li><a href="#implementation-details" class="table-of-contents__link toc-highlight">Implementation details</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/">User guide</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/facebook/buck2/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub issues<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/facebook/buck2" target="_blank" rel="noopener noreferrer" class="footer__link-item">Code<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.fb.com/legal/terms" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms of Use<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.fb.com/legal/privacy" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy Policy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Meta Platforms, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.2dd65051.js"></script>
<script src="/assets/js/main.e0147cf1.js"></script>
</body>
</html>