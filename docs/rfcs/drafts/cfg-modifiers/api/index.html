<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-rfcs/drafts/cfg-modifiers/api">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">[RFC] Configuration Modifiers | Buck2</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://buck2.build/docs/rfcs/drafts/cfg-modifiers/api/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="[RFC] Configuration Modifiers | Buck2"><meta data-rh="true" name="description" content="Why do we need new configuration setup?"><meta data-rh="true" property="og:description" content="Why do we need new configuration setup?"><link data-rh="true" rel="icon" href="/img/logo.png"><link data-rh="true" rel="canonical" href="https://buck2.build/docs/rfcs/drafts/cfg-modifiers/api/"><link data-rh="true" rel="alternate" href="https://buck2.build/docs/rfcs/drafts/cfg-modifiers/api/" hreflang="en"><link data-rh="true" rel="alternate" href="https://buck2.build/docs/rfcs/drafts/cfg-modifiers/api/" hreflang="x-default"><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-GEGGHE39PE"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-GEGGHE39PE",{anonymize_ip:!0})</script><link rel="stylesheet" href="/assets/css/styles.96950b1b.css">
<link rel="preload" href="/assets/js/runtime~main.2dd65051.js" as="script">
<link rel="preload" href="/assets/js/main.e0147cf1.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script>
<div style="display: none; text-align: center; background-color: white; color: black;" id="internaldocs-banner"></div><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Buck2</b></a><a class="navbar__item navbar__link" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/docs/api/rules/">Rules</a><a class="navbar__item navbar__link" href="/docs/api/">API</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/buck2" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><main class="docMainContainer_gTbr docMainContainerEnhanced_Uz_u"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>[RFC]<!-- --> Configuration Modifiers</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="why-do-we-need-new-configuration-setup">Why do we need new configuration setup?<a href="#why-do-we-need-new-configuration-setup" class="hash-link" aria-label="Direct link to Why do we need new configuration setup?" title="Direct link to Why do we need new configuration setup?">​</a></h2><p>A target usually needs to be built in multiple build settings.
For example, there may be different OS (ex. linux, mac, windows),
architectures (ex. x86, arm), and sanitizers
(ex. asan, tsan, ubsan) to use for a single target. Buck has 2 main ways of supporting customizations today:</p><ol><li>Buckconfigs specified through <code>--config</code> or <code>-c</code> flags. They are global flags and are often aggregated in modefiles (<code>@&lt;modefile&gt;</code> on the command line).</li><li>Target platforms specified through <code>default_target_platform</code> attribute or <code>--target-platforms</code> flag), which become a target&#x27;s &quot;configuration&quot;. <code>--target-platforms</code> flags are also commonly specified via modefiles.</li></ol><p>These methods are problematic for the following reasons.</p><ol><li><p><em>We have too many modefiles</em>. A project that needs customizations often ends
up adding its own set of modefiles, causing a continued rise in number of
custom modefiles in the repo. Internally, the number of modefiles in our
monorepo is currently on the order of <strong>10,000s</strong>.</p></li><li><p><em>Changing buckconfigs invalidates Buck&#x27;s state</em>. Changing buckconfigs or
modefiles of buckconfigs invalidates global state, which adds non-trivial Buck
overhead on every incremental build that changes state. This does not affect
target platforms.</p></li><li><p><em>Different modefiles of buckconfigs cannot be used in same build</em>.
Users that need to run multi-configuration builds today often work around this
by writing scripts that wraps multiple buck build invocations of different
modes. This is slow because Buck state keeps getting repeatedly invalidated.
There is also no way to build a target in different modes (ex. dev and opt) at
the same time, so users that need to do this always have to do this
sequentially. This does not affect target platforms.</p></li><li><p><em>Target platform generation is exponential in number of build settings</em>.
Suppose I want to customize targets based on 3 OSes, 2 architectures, and 3
compilers. With target platforms, I need to first generate all 18 permutations
of these settings as platform targets before using them. This is not scalable.</p></li><li><p><em>Target platform does not compose well on command line</em>. Suppose I want to
use ASAN on top of some existing platform. It&#x27;s not possible to say specify
ASAN on top of an existing platform on the command line. Instead, I must create
a new platform target with ASAN added to the existing platform before I can use
it.</p></li><li><p><em>Poor user Experience</em>. When every project needs its own set of modes, it&#x27;s
onerous for users to track what modes are needed to build what targets. Users
often don&#x27;t realize when they are using the wrong or unnecessary command line
flags.</p></li><li><p><em>Poor tooling integration</em>. Similar to user, it&#x27;s just onerous for tooling
to keep track of what modes are needed to build a target with. Buckconfigs are
also bad for performance for tools like language servers because it&#x27;s impossible
to request the builds of two modes in parallel when two targets needs different
modes.</p></li><li><p><em>Antithetical to Buck&#x27;s principles</em>. Buck&#x27;s main strength is the ability to abstract away builds of different languages and libraries under one common syntax for the user. The need for project-custom flags goes against this principle.</p></li></ol><p>The Modifier API introduces a unified way to specify build settings on a
project, target, and command line level. Like target platforms, it constructs Buck configurations so it supports multi-configuration builds. It
avoids modefile proliferation by allowing users to easily
set project-specific build settings like compiler and toolchain versions in
the repo rather than on the command line. It avoids scalability problems of
platform generation by being composition-first. The goals of this project is to:</p><ol><li><em>Make <code>buck build</code> work on any platform without the use of special flags</em>.
Today, building a mac target on mac often requires a mac mode,
and likewise for windows. Instead, <code>buck build</code> should always work
out of the box on any platform so that there&#x27;s no need to specify mac mode on
macs or windows mode on windows.</li><li><em>Define a small constrained set of common modifiers that can be used to build any target
in the repo</em>. This will include common options like mode (ex. dev, opt, release), OS (ex. linux, mac, iphoneos), and architecture (ex. x86, arm).</li><li><em>Unblock cross-building for the majority of targets</em>. <code>host_info()</code> is
a hack to obtain information about the host machine that is the main blocker to
Buck2 cross-building (ex. building a mac or windows
target from linux) working everywhere. As an extension of &quot;making <code>buck build</code>
work on any platform&quot;, modifiers should make it possible to kill off most use cases of <code>host_info</code> in the repo.</li><li><em>Simplify building build tooling</em>. Because <code>buck build</code> works out of
the box, tools like language servers can build targets they need without using
project-specific modefiles or flags.</li><li><em>Delete most modefiles from the repo</em>.</li><li><em>Deprecate target platforms for modifiers as the sole way of configuring top-level
targets in Buck</em>.</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="configuration-background">Configuration Background<a href="#configuration-background" class="hash-link" aria-label="Direct link to Configuration Background" title="Direct link to Configuration Background">​</a></h2><p><em>Feel free to skip this if you already understand Buck configurations.</em></p><p>A configuration is a collection of <code>constraint_value</code> targets
(commonly referred to as constraints).
It defines the build settings used by a target.
A constraint value is keyed by a <code>constraint_setting</code>, so there can only
be one <code>constraint_value</code> of a <code>constraint_setting</code> in a configuration.</p><p>For example, suppose <code>cfg//os:_</code> is a constraint setting with constraint
values <code>cfg//os:linux</code>, <code>cfg//os:macos</code>, and <code>cfg//os:windows</code>. Then
a configuration may contain either <code>cfg//os:linux</code>, <code>cfg//os:macos</code>,
or <code>cfg//os:windows</code> to indicate which OS a target is built for.</p><p>A constraint or a set of constraints can be selected on via <code>select()</code> to
customize a target&#x27;s behavior. For example, the following adds a linux only
dep to a target.</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">deps </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> select</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token string" style="color:#e3116c">&quot;cfg//os:linux&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;:linux_only_dep&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token string" style="color:#e3116c">&quot;DEFAULT&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Before building a target on the command line (known as the top-level target),
Buck needs to know its configuration in order to resolve selects. Modifiers
are a new way to resolve a target&#x27;s configuration for every top-level target.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="api">API<a href="#api" class="hash-link" aria-label="Direct link to API" title="Direct link to API">​</a></h2><p>Every top-level target starts with an empty configuration, and Buck will apply
a list of &quot;modifiers&quot; to obtain a configuration. A modifier is a modification
of a constraint from the existing configuration to obtain a new
configuration.</p><p>The simplest modifier is a constraint value, which inserts
that value into the configuration for its respective constraint setting,
replacing any existing constraint value for that setting.
For example, specifying <code>cfg//os:linux</code> as a modifier will
insert <code>cfg//os:linux</code> into the configuration,
overriding any existing constraint value for the
<code>cfg//os:_</code> constraint setting.</p><p>Another type of modifier is a <code>modifier_select()</code> of a constraint value.
This can change the constraint value inserted based on the existing
configuration. For example, a modifier like</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">modifier_select</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;cfg//os:windows&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;cfg//compiler:msvc&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;DEFAULT&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;cfg//compiler:clang&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>will insert msvc constraint into the configuration if OS is windows or clang
constraint otherwise.
A <code>modifier_select()</code> behaves similarly to Buck&#x27;s <code>select()</code> but can only
be used in a modifier.
A <code>modifier_select()</code> can only be used to modify a single constraint setting,
so the following example is not valid.</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># This fails because a modifier cannot modify both compiler and OS.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">modifier_select</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;cfg//os:windows&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;cfg//compiler:msvc&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;DEFAULT&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;cfg//os:linux&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>A modifier can be specified in a PACKAGE file, on a target, or on the command
line. This provides the flexibility needed to customize targets on a project,
target, or cli level.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="package-modifier">PACKAGE Modifier<a href="#package-modifier" class="hash-link" aria-label="Direct link to PACKAGE Modifier" title="Direct link to PACKAGE Modifier">​</a></h3><p>In a PACKAGE file, modifiers can be specified using the <code>cfg_modifiers</code>
function and would apply to all targets covered under that PACKAGE. For
example, modifiers specified in <code>repo/PACKAGE</code> would apply to any target under
<code>repo//...</code>. Modifiers specified in <code>repo/foo/PACKAGE</code> would apply to any target under <code>repo//foo/...</code> (For resolution order, see &quot;Modifier
Resolution&quot; section).</p><p>The <code>cfg_modifiers</code> function takes as input
a dictionary of constraint setting to modifier for that setting.
For example, the following is an example that sets modifiers for OS and compiler settings in the repo&#x27;s top PACKAGE file for all targets in repo.</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># repo/PACKAGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cfg_modifiers</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;cfg//os:_&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;cfg//:linux&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;cfg//compiler:_&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> modifier_select</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;DEFAULT&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;cfg//compiler:clang&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;cfg//os:windows&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;cfg//compiler:msvc&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>To make constraints easier to type, you can specify aliases for modifier targets
via Buck&#x27;s target aliases.</p><p>For example, suppose the following aliases exist in <code>repo/.buckconfig</code>.</p><div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[alias]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  os = cfg//os:_</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  linux = cfg//os:linux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  macos = cfg//os:macos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  windows = cfg//os:windows</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  compiler = cfg//compiler:_</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  clang = cfg//compiler:clang</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  msvc = cfg//compiler:msvc</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Then the same PACKAGE modifiers can be specified as follows.</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># repo/PACKAGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cfg_modifiers</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;os&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;linux&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;compiler&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> modifier_select</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;DEFAULT&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;clang&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;windows&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;msvc&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="target-modifier">Target Modifier<a href="#target-modifier" class="hash-link" aria-label="Direct link to Target Modifier" title="Direct link to Target Modifier">​</a></h3><p>On a target, modifiers can be specified on the <code>cfg_modifiers</code> attribute.
For example, the following specifies modifiers for <code>repo//foo:bar</code>.</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># repo/foo/BUCK</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">python_binary</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;bar&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cfg_modifiers </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;cfg//os:_&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;cfg//os:windows&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Target modifiers can also use aliases</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;compiler&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;clang&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="cli-modifier">CLI Modifier<a href="#cli-modifier" class="hash-link" aria-label="Direct link to CLI Modifier" title="Direct link to CLI Modifier">​</a></h3><p>On the command line, modifiers are specified as
<code>buck2 build &lt;target&gt;?&lt;modifiers separated by commas&gt;</code>.</p><p>For example,
<code>buck2 build repo//foo:bar?cfg//sanitizer:asan</code> applies asan
modifier on the command line.
<code>buck2 build repo//foo:bar?cfg//os:linux,cfg//sanitizer:asan</code>
will apply linux and asan modifiers.
Aliases can also be used on command line, so
<code>buck2 build repo//foo:bar?asan</code> is valid.</p><p>Command line modifiers cannot be selects, although this may
be revisited if necessary.</p><p>Modifiers can be specified for any target pattern, so
<code>buck2 build repo//foo/...?asan</code> and
<code>buck2 build repo//foo:?asan</code> are also valid.
When specifying a subtarget and modifier with <code>?</code>,
subtarget should go before modifier,
ex. <code>buck2 build repo//foo:bar[comp-db]?asan</code>.</p><p>To specify modifiers to a list of target patterns on the command line,
you can use the <code>--modifier</code> or <code>-m</code> flag.
For example, <code>buck2 build repo//foo:bar repo//foo:baz -m release</code>
is equivalent to <code>buck2 build repo//foo:bar?release //foo:baz?release</code>.</p><p><code>--modifier</code> flag can be specified multiple times to add multiple modifier, so
<code>buck2 build --modifier=linux --modifier=release repo//foo:bar</code>
is equivalent to <code>buck2 build repo//foo:bar?linux,release</code>.</p><p>It is prohibited to specify both <code>--modifier</code> flag and <code>?</code> in target pattern.
This restriction can be lifted in the future if there is a need.</p><p>When two modifiers of the same constraint setting are specified, then the later one overrides the earlier one. For example,
<code>buck2 build repo//foo:bar?dev,release</code> is equivalent to
<code>buck2 build repo//foo:bar?release</code>.</p><p>On command line, a <code>config_setting</code> target can be specified as a collection of
modifiers after <code>--modifier</code> or <code>?</code>. This will be equivalent to specifying each
constraint inside the <code>config_setting</code> as a separate modifier.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="modifier-resolution">Modifier Resolution<a href="#modifier-resolution" class="hash-link" aria-label="Direct link to Modifier Resolution" title="Direct link to Modifier Resolution">​</a></h3><p>Modifiers are resolved in order of constraint setting, and for each constraint
setting, modifiers for that setting are resolved in order of PACKAGE, target,
and command line, with modifier from parent PACKAGE applied before child
PACKAGE. The end of this section will describe how Buck determines the order
of constraint setting to resolve.</p><p>Suppose modifiers for <code>repo//foo:bar</code> are specified as follows.</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># repo/PACKAGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cfg_modifiers</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;cfg//os:_&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;cfg//:linux&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;cfg//compiler:_&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> modifier_select</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;DEFAULT&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;cfg//compiler:clang&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;cfg//os:windows&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;cfg//compiler:msvc&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># repo/foo/PACKAGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cfg_modifiers</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;cfg//os:_&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;cfg//os:macos&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># repo/foo/BUCK</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">python_binary</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;bar&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cfg_modifiers </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;cfg//os:_&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;cfg//os:windows&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>At the beginning, the configuration will be empty.
When resolving modifiers, Buck will first resolve all modifiers for
<code>cfg//os:_</code> before resolving all modifiers for <code>cfg//compiler:_</code>.</p><p>For OS, the linux modifier from <code>repo/PACKAGE</code> will apply first, followed by
macos modifier from <code>repo/foo/PACKAGE</code> and windows modifier from
<code>repo//foo:bar</code>&#x27;s target modifiers, so <code>repo//foo:bar</code> will end up with
<code>cfg//os:windows</code> for <code>cfg//os:_</code> in its configuration. Next, to resolve
compiler modifier, the <code>modifier_select</code> from <code>repo/PACKAGE</code> will resolve to
<code>cfg//compiler:msvc</code> since existing configuration is windows and apply that as
the modifier. The target configuration for <code>repo//foo:bar</code> ends up with windows
and msvc.</p><p>However, suppose user invokes <code>repo//foo:bar?linux</code> on the command line. When
resolving OS modifier, the linux modifier from cli will override any existing
OS constraint and insert linux into the configuraiton. Then, when resolving the
compiler modifier, the <code>modifier_select</code> will resolve to <code>cfg//compiler:clang</code>,
giving clang and linux as the final configuration.</p><p>Because command line modifiers will apply at the end, they
are also known as required modifiers. Any modifier specified on the command line
will always override any modifier for the same constraint setting specified in
the repo.</p><p>The ordering of constraint setting to resolve modifiers is determined based on
dependency order of constraints specified in the keys of the <code>modifier_select</code>
specified. Because some modifiers select on other constraints, modifiers for
those constraints must be resolved first. In the previous example, because
compiler modifier selects on OS constraints, Buck will resolve all
OS modifiers before resolving compiler modifiers.
<code>modifier_select</code> that ends up with a cycle of selected constraints
(ex. compiler modifier selects on sanitizer but sanitizer modifier also selects
on compiler) will be an error.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="modifier-specific-selects">Modifier-Specific Selects<a href="#modifier-specific-selects" class="hash-link" aria-label="Direct link to Modifier-Specific Selects" title="Direct link to Modifier-Specific Selects">​</a></h3><p>Modifiers have 3 types of select operators that allow for powerful compositions.
Each operation is a function that accepts a dictionary where the keys are
conditionals and values are modifiers.</p><ol><li><p><code>modifier_select</code>. Introduced in the previous sections, this is capable of
inserting constraints based on constraints in the existing configuration.</p></li><li><p><code>rule_select</code>. This is capable of selecting based on the rule name (also
known as rule type). The keys are regex patterns to match against the rule
name or &quot;DEFAULT&quot;. Partial matches are allowed.</p></li><li><p><code>host_select</code>. This selects based on the host configuration,
whereas <code>modifier_select</code> selects based on the target configuration. This
host configuration is constructed when resolving modifiers. <code>host_select</code> is
important to making <code>buck build</code> work anywhere on any platform. For example,
when the OS to configure is not specified, it&#x27;s best to assume that the user
wants to target the same OS as the host machine.</p></li></ol><p>An example using <code>rule_select</code> and <code>host_select</code> is as follows.</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># root/PACKAGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># We want OS to target the host machine by default.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Ex. build linux on linux machine, build windows on windows machine,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># and build mac on mac machine.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># However, if the rule is apple or android specific, then we should</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># always be building for apple/android as OS, no matter the host</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># configuration.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cfg_modifiers</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;cfg//os:_&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> rule_select</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;apple_.*&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;cfg//os:iphone&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;android_.*&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;cfg//os:android&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;DEFAULT&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> host_select</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;cfg//os:linux&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;cfg//os:linux&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;cfg//os:macos&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;cfg//os:macos&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;cfg//os:windows&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;cfg//os:windows&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>On select resolution, Buck&#x27;s <code>select</code> currently requires unambiguous
keys in the dictionary and resolves to the key with the most refined match.
The select operators used in modifiers will diverge from this and implement
a &quot;first-match&quot; behavior, where select resolves to the first condition that evalutes to true in the dictionary.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="legacy-target-platform">Legacy Target platform<a href="#legacy-target-platform" class="hash-link" aria-label="Direct link to Legacy Target platform" title="Direct link to Legacy Target platform">​</a></h3><p>Target platform (<code>--target-platforms</code> flag or <code>default_target_platform</code>
attribute) will be a deprecated way of specifying configuration and will be
killed once all use cases migrate to modifiers. To maintain backwards compatibility
with target platforms during the migration process, modifier resolution
will take into account the target platform specified. This allows for an easy
migration where modifiers can be introduced one at a time without reaching
feature parity of target platform.</p><p>If a target&#x27;s modifiers resolve to an empty configuration, then Buck will reuse
the target platform as the configuration. If modifiers resolve to a non-empty
configuration, then Buck look for any constraint in the target platform not
covered by a constraint setting from the modifier configuration and add those
to the configuration.
For example, suppose in the previous example, the target platform for <code>repo//
foo:bar</code> includes <code>cfg//sanitizer:asan</code>, then this constraint will be inserted
into the configuration since no modifier covered the sanitizer constraint
setting.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="debugging-modifiers">Debugging modifiers<a href="#debugging-modifiers" class="hash-link" aria-label="Direct link to Debugging modifiers" title="Direct link to Debugging modifiers">​</a></h2><p>Because many layers of modifiers can be applied before obtaining
a final configuration, it is important that modifier resolution is easy
to debug and understand. Here are some ways that modifier resolution
can be interpreted.</p><ol><li><p><em><code>buck2 audit modifiers</code> command</em>. There will be a <code>buck2 audit modifiers</code>
command to show all PACKAGE, target, and required modifiers for a target. It
can also show configuration changes from modifier resolution process if
requested by the user.</p></li><li><p><em>Starlark print statements or debugger</em>.
Modifier resolution process will be implemented in Starlark in prelude.
This means that any user can use any of the existing way to debug starlark
(ex. print statements, Starlark debugger in VSCode) to debug the resolution
process.</p></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-configuration-modifiers-differ-from-transitions">How configuration modifiers differ from transitions<a href="#how-configuration-modifiers-differ-from-transitions" class="hash-link" aria-label="Direct link to How configuration modifiers differ from transitions" title="Direct link to How configuration modifiers differ from transitions">​</a></h2><p>Modifiers are largely inspired by configuration transitions.
The difference between modifier and transition is that a transition can change
the configuration of any target in the graph, but a modifier can only change
the configuration of a top-level target. In other words, if you have target A
that depends on target B and you request a build of A, then A&#x27;s target
configuration would be resolved via modifiers and propagated down to B, but dep
B would not do its own modifier resolution. When a top-level target goes through
a per-rule transition, that transition is applied after modifiers are resolved.</p><p>Below are some examples that show when to use modifier and when to use
transition.</p><ol><li><em>Python version</em> should be modeled as a transition and not modifier.
Suppose we have <code>python_binary</code> A nested as a resource of
another <code>python_binary</code> B. A should not inherit the python version
from B, so a transition is needed to change A&#x27;s python version
when depended on by B.</li><li><em>Library target</em> should use modifiers and not transitions.
A C++ library target should always inherit the configuration
of its parent C++ binary when it is used as a dep,
but a top-level C++ library target can still have its configuration
changed via modifiers when requested from command line.</li></ol><p>In the future, we may add support for modifier transition, which can
transition via modifiers, but that is out of the scope of this RFC.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#why-do-we-need-new-configuration-setup" class="table-of-contents__link toc-highlight">Why do we need new configuration setup?</a></li><li><a href="#configuration-background" class="table-of-contents__link toc-highlight">Configuration Background</a></li><li><a href="#api" class="table-of-contents__link toc-highlight">API</a><ul><li><a href="#package-modifier" class="table-of-contents__link toc-highlight">PACKAGE Modifier</a></li><li><a href="#target-modifier" class="table-of-contents__link toc-highlight">Target Modifier</a></li><li><a href="#cli-modifier" class="table-of-contents__link toc-highlight">CLI Modifier</a></li><li><a href="#modifier-resolution" class="table-of-contents__link toc-highlight">Modifier Resolution</a></li><li><a href="#modifier-specific-selects" class="table-of-contents__link toc-highlight">Modifier-Specific Selects</a></li><li><a href="#legacy-target-platform" class="table-of-contents__link toc-highlight">Legacy Target platform</a></li></ul></li><li><a href="#debugging-modifiers" class="table-of-contents__link toc-highlight">Debugging modifiers</a></li><li><a href="#how-configuration-modifiers-differ-from-transitions" class="table-of-contents__link toc-highlight">How configuration modifiers differ from transitions</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/">User guide</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/facebook/buck2/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub issues<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/facebook/buck2" target="_blank" rel="noopener noreferrer" class="footer__link-item">Code<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.fb.com/legal/terms" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms of Use<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.fb.com/legal/privacy" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy Policy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Meta Platforms, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.2dd65051.js"></script>
<script src="/assets/js/main.e0147cf1.js"></script>
</body>
</html>