"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[7585],{3905:(e,t,n)=>{n.r(t),n.d(t,{MDXContext:()=>d,MDXProvider:()=>c,mdx:()=>f,useMDXComponents:()=>p,withMDXComponents:()=>u});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(){return i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},i.apply(this,arguments)}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var d=a.createContext({}),u=function(e){return function(t){var n=p(t.components);return a.createElement(e,i({},t,{components:n}))}},p=function(e){var t=a.useContext(d),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=p(e.components);return a.createElement(d.Provider,{value:t},e.children)},m="mdxType",h={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},x=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),u=p(n),c=r,m=u["".concat(s,".").concat(c)]||u[c]||h[c]||i;return n?a.createElement(m,o(o({ref:t},d),{},{components:n})):a.createElement(m,o({ref:t},d))}));function f(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,s=new Array(i);s[0]=x;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o[m]="string"==typeof e?e:r,s[1]=o;for(var d=2;d<i;d++)s[d]=n[d];return a.createElement.apply(null,s)}return a.createElement.apply(null,n)}x.displayName="MDXCreateElement"},90013:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>h,frontMatter:()=>i,metadata:()=>o,toc:()=>d});var a=n(87462),r=(n(67294),n(3905));const i={id:"transitive_sets",title:"Transitive Sets"},s=void 0,o={unversionedId:"rule_authors/transitive_sets",id:"rule_authors/transitive_sets",title:"Transitive Sets",description:"Transitive sets enable the propagation of data up dependency trees in a manner that is both efficient in Starlark code (low cost of creation, low memory usage) and efficient for execution by Buck (edges can be shared instead of having each action depend directly on all its inputs).",source:"@site/../docs/rule_authors/transitive_sets.md",sourceDirName:"rule_authors",slug:"/rule_authors/transitive_sets",permalink:"/docs/rule_authors/transitive_sets",draft:!1,tags:[],version:"current",frontMatter:{id:"transitive_sets",title:"Transitive Sets"},sidebar:"manualSidebar",previous:{title:"Rule APIs",permalink:"/docs/rule_authors/rule_api"},next:{title:"Configurations",permalink:"/docs/rule_authors/configurations"}},l={},d=[{value:"Rule API",id:"rule-api",level:2},{value:"Projections: using transitive sets in command lines",id:"projections-using-transitive-sets-in-command-lines",level:2},{value:"Projections: using transitive sets in write_json()",id:"projections-using-transitive-sets-in-write_json",level:2},{value:"Traversals in depth",id:"traversals-in-depth",level:3},{value:"Other APIs",id:"other-apis",level:2},{value:"Transitive set reductions",id:"transitive-set-reductions",level:3},{value:"Transitive set iteration",id:"transitive-set-iteration",level:3},{value:"Ordering",id:"ordering",level:3},{value:"Implementation details",id:"implementation-details",level:2},{value:"Projection evaluation",id:"projection-evaluation",level:3}],u=e=>function(t){return console.warn("Component "+e+" was not imported, exported, or provided by MDXProvider as global scope"),(0,r.mdx)("div",t)},p=u("Mermaid"),c=u("FbInternalOnly"),m={toc:d};function h(e){let{components:t,...n}=e;return(0,r.mdx)("wrapper",(0,a.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,r.mdx)("p",null,"Transitive sets enable the propagation of data up dependency trees in a manner that is both efficient in Starlark code (low cost of creation, low memory usage) and efficient for execution by Buck (edges can be shared instead of having each action depend directly on all its inputs)."),(0,r.mdx)("p",null,"Examples of where transitive sets are useful include:"),(0,r.mdx)("ul",null,(0,r.mdx)("li",{parentName:"ul"},"Propagating transitive link-time dependencies of a library all the way to a binary to build."),(0,r.mdx)("li",{parentName:"ul"},"Propagating transitive compile-time headers.")),(0,r.mdx)("h2",{id:"rule-api"},"Rule API"),(0,r.mdx)("p",null,"First, you need to declare your transitive set type, then you can use it, as follows:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-starlark"},'# This is the type\nMySet = transitive_set()\n\n# Those are transitive sets:\nset1 = ctx.actions.tset(MySet, value = "foo")\nset2 = ctx.actions.tset(MySet, value = "bar", children = [set1])\n')),(0,r.mdx)("p",null,"Values are optional, and so are children. This means you can have a set with no value and sets with no children."),(0,r.mdx)("h2",{id:"projections-using-transitive-sets-in-command-lines"},"Projections: using transitive sets in command lines"),(0,r.mdx)("p",null,"Sets aren't useful unless you can use their contents!"),(0,r.mdx)("p",null,"To use a set in a command line, you use a concept called a 'projection', which defines how to turn individual values found in the set into command line arguments."),(0,r.mdx)("p",null,"To define a projection, you write a function that takes a value of your set and returns a command-line like object (",(0,r.mdx)("inlineCode",{parentName:"p"},"cmd_args"),", ",(0,r.mdx)("inlineCode",{parentName:"p"},"string"),", ",(0,r.mdx)("inlineCode",{parentName:"p"},"attr.arg()")," attributes, ",(0,r.mdx)("inlineCode",{parentName:"p"},"artifact"),", and so on) or a list of them in whichever way makes sense for your use case."),(0,r.mdx)("p",null,"Then, you call ",(0,r.mdx)("inlineCode",{parentName:"p"},"project_as_args")," to turn a set into a value suitable for inclusion in a command line. When expanded, this projection will expand like a list of all the node's individual projected values."),(0,r.mdx)("p",null,"Following is an example:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-starlark"},'# Declare the projection\ndef project_as_define(value: str):\n  return cmd_args(value, format = "-D{}")\n\n# Add it to the set definition\nMySet = transitive_set(args_projections = { "define": project_as_define })\n\n# Create a set\nset1 = ctx.actions.tset(MySet, value = "foo")\nset2 = ctx.actions.tset(MySet, value = "bar", children = [set1])\n\n# Call the projection.\n# Note "define" is the key used above in `args_projections`.\nargs = set2.project_as_args("define")\n')),(0,r.mdx)("p",null,"When you use ",(0,r.mdx)("inlineCode",{parentName:"p"},"args")," in a command line, it will expand to ",(0,r.mdx)("inlineCode",{parentName:"p"},"-Dbar -Dfoo"),"."),(0,r.mdx)("p",null,"Note that creating projections is very cheap. Notably, it is independent of the size of the set."),(0,r.mdx)("h2",{id:"projections-using-transitive-sets-in-write_json"},"Projections: using transitive sets in write_json()"),(0,r.mdx)("p",null,"As with command lines, sets can form json projections to be used in write_json."),(0,r.mdx)("p",null,"A json projection is defined in the same way as an arg projection. The function should return a value that ",(0,r.mdx)("inlineCode",{parentName:"p"},"write_json")," otherwise supports. Then, you call ",(0,r.mdx)("inlineCode",{parentName:"p"},"project_as_json")," to turn a set into a value that can be passed to ",(0,r.mdx)("inlineCode",{parentName:"p"},"write_json")," (or can appear within the value passed to it, it doesn't need to be the top-level value). When expanded, the projection will expand like a list of all the node's individual projected values."),(0,r.mdx)("p",null,"Following is an example:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-starlark"},'# Declare the projection\ndef project_as_json(value: str):\n  return struct(key = "foo", value = value)\n\n# Add it to the set definition\nMySet = transitive_set(json_projections = { "define": project_as_json })\n\n# Create a set\nset1 = ctx.actions.tset(MySet, value = "foo")\nset2 = ctx.actions.tset(MySet, value = "bar", children = [set1])\n\n# Call the projection.\n# Note "define" is the key we used above in `json_projections`.\nargs = set2.project_as_json("define")\n')),(0,r.mdx)("p",null,"Note that if your projected values include (or may include) artifacts, you will likely want to use ",(0,r.mdx)("inlineCode",{parentName:"p"},"write_json(with_inputs=True)")," to get back a cmd_args that has all the artifacts in the json structure already in its ",(0,r.mdx)("inlineCode",{parentName:"p"},".hidden"),"."),(0,r.mdx)("h3",{id:"traversals-in-depth"},"Traversals in depth"),(0,r.mdx)("p",null,"Transitive sets form DAGs. Notably, this means individual nodes can exist more than once in a given transitive set."),(0,r.mdx)("p",null,"When a transitive set is traversed, nodes that have already been visited are skipped. This means their arguments will only be emitted once."),(0,r.mdx)("p",null,"For example:"),(0,r.mdx)(p,{chart:"\nflowchart TD\n  foo((foo))\n  bar((bar))\n  qux((qux))\n  qux --\x3e foo\n  bar --\x3e foo\n  qux --\x3e bar\n",mdxType:"Mermaid"}),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-starlark"},'set1 = ctx.actions.tset(MySet, value = "foo")\nset2 = ctx.actions.tset(MySet, value = "bar", children = [set1])\nset3 = ctx.actions.tset(MySet, value = "qux", children = [set1, set2])\n\nargs = set3.project_as_args("define")\n')),(0,r.mdx)("p",null,"This will expand to ",(0,r.mdx)("inlineCode",{parentName:"p"},"-Dqux -Dfoo -Dbar"),", even though ",(0,r.mdx)("inlineCode",{parentName:"p"},"set1")," (",(0,r.mdx)("inlineCode",{parentName:"p"},'"foo"'),") shows up twice in the DAG."),(0,r.mdx)("h2",{id:"other-apis"},"Other APIs"),(0,r.mdx)("h3",{id:"transitive-set-reductions"},"Transitive set reductions"),(0,r.mdx)("p",null,"You can aggregate values of a transitive set via a reduction. This can be helpful for tasks such as propagating Boolean flags up the tree."),(0,r.mdx)("p",null,"Following is a real-world example."),(0,r.mdx)("p",null,"When defining a reduction, you receive the reduced values of all your children, and an optional value for the current node (the value will be ",(0,r.mdx)("inlineCode",{parentName:"p"},"None")," when you create a set and you don't pass a ",(0,r.mdx)("inlineCode",{parentName:"p"},"value"),"), and you need to merge them together to produce this node's value:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-starlark"},'def link_info_has_default_filelist(children: ["bool"], infos: ["LinkInfos", None]):\n    if infos:\n        info = infos.default\n        if info.filelist:\n            return True\n    return any(children)\n\n# Set of LinkInfos\nLinkInfosTSet = transitive_set(\n    reductions = {\n        "has_default_filelist": link_info_has_default_filelist,\n    },\n)\n')),(0,r.mdx)("h3",{id:"transitive-set-iteration"},"Transitive set iteration"),(0,r.mdx)("p",null,"You ",(0,r.mdx)("em",{parentName:"p"},"can")," iterate over a transitive set. This will yield each value once. You can also iterate over projections."),(0,r.mdx)("p",null,"However, note that this is generally not recommended, since unlike creating and using a projection, this operation is ",(0,r.mdx)("inlineCode",{parentName:"p"},"O(set)"),"."),(0,r.mdx)("p",null,"You should use this as an escape hatch if and only if you need to implement something transitive sets don't support via projections or reductions, because in doing so you'll lose a lot of the performance benefits."),(0,r.mdx)("p",null,"For example:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-starlark"},'set1 = ctx.actions.tset(MySet, value = "foo")\nset2 = ctx.actions.tset(MySet, value = "bar", children = [set1])\nset3 = ctx.actions.tset(MySet, value = "qux", children = [set1, set2])\n\nvalues = list(set3.traverse())\n')),(0,r.mdx)("p",null,"This will yield ",(0,r.mdx)("inlineCode",{parentName:"p"},'["qux", "foo", "bar"]'),"."),(0,r.mdx)("h3",{id:"ordering"},"Ordering"),(0,r.mdx)("p",null,"Transitive set iteration uses a left-to-right, pre-order traversal by default, and ignores nodes that have already been visited. This order is reflected in projections as well."),(0,r.mdx)("p",null,"A few different traversal orders are supported with the ",(0,r.mdx)("inlineCode",{parentName:"p"},"ordering")," attribute:"),(0,r.mdx)("table",null,(0,r.mdx)("thead",{parentName:"table"},(0,r.mdx)("tr",{parentName:"thead"},(0,r.mdx)("th",{parentName:"tr",align:null},"Ordering"),(0,r.mdx)("th",{parentName:"tr",align:null},"Description"))),(0,r.mdx)("tbody",{parentName:"table"},(0,r.mdx)("tr",{parentName:"tbody"},(0,r.mdx)("td",{parentName:"tr",align:null},(0,r.mdx)("inlineCode",{parentName:"td"},"preorder")," (default)"),(0,r.mdx)("td",{parentName:"tr",align:null},"Traverses using a depth-first-search, visiting nodes left-to-right.")),(0,r.mdx)("tr",{parentName:"tbody"},(0,r.mdx)("td",{parentName:"tr",align:null},(0,r.mdx)("inlineCode",{parentName:"td"},"postorder")),(0,r.mdx)("td",{parentName:"tr",align:null},"Traverses children left-to-right, and then visits the current node.")),(0,r.mdx)("tr",{parentName:"tbody"},(0,r.mdx)("td",{parentName:"tr",align:null},(0,r.mdx)("inlineCode",{parentName:"td"},"topological")),(0,r.mdx)("td",{parentName:"tr",align:null},"A Topological sort, such that nodes are listed after all nodes that have them as descendants. This is similar to a pre-order traversal, except that when nodes are shared with more than one parent it is returned in the order of its last occurrence.")),(0,r.mdx)("tr",{parentName:"tbody"},(0,r.mdx)("td",{parentName:"tr",align:null},(0,r.mdx)("inlineCode",{parentName:"td"},"bfs")),(0,r.mdx)("td",{parentName:"tr",align:null},"Breadth-first-search (BFS) traversal, traverses nodes left-to-right before traversing children.")))),(0,r.mdx)("p",null,"For example:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-starlark",metastring:"src=fbcode/buck2/app/buck2_build_api_tests/src/interpreter/transitive_set/tests.rs",src:"fbcode/buck2/app/buck2_build_api_tests/src/interpreter/transitive_set/tests.rs"},'set1 = ctx.actions.tset(MySet, value = "foo")\nset2 = ctx.actions.tset(MySet, value = "bar", children = [set1])\nset3 = ctx.actions.tset(MySet, value = "qux", children = [set1, set2])\n\nvalues = list(set3.traverse(ordering = "topological"))\n\n# This also works for projections\nargs = set3.project_as_args("project", ordering = "topological"))\n')),(0,r.mdx)("p",null,"Following is an example of how different orderings evaluate:"),(0,r.mdx)(p,{chart:"\nflowchart TD\n  foo((foo))\n  bar((bar))\n  qux((qux))\n  qux --\x3e foo\n  bar --\x3e foo\n  qux --\x3e bar\n",mdxType:"Mermaid"}),(0,r.mdx)("table",null,(0,r.mdx)("thead",{parentName:"table"},(0,r.mdx)("tr",{parentName:"thead"},(0,r.mdx)("th",{parentName:"tr",align:null},"Ordering"),(0,r.mdx)("th",{parentName:"tr",align:null},"Result"))),(0,r.mdx)("tbody",{parentName:"table"},(0,r.mdx)("tr",{parentName:"tbody"},(0,r.mdx)("td",{parentName:"tr",align:null},(0,r.mdx)("inlineCode",{parentName:"td"},"preorder")),(0,r.mdx)("td",{parentName:"tr",align:null},(0,r.mdx)("inlineCode",{parentName:"td"},'["qux", "foo", "bar"]'))),(0,r.mdx)("tr",{parentName:"tbody"},(0,r.mdx)("td",{parentName:"tr",align:null},(0,r.mdx)("inlineCode",{parentName:"td"},"postorder")),(0,r.mdx)("td",{parentName:"tr",align:null},(0,r.mdx)("inlineCode",{parentName:"td"},'["foo", "bar", "qux"]'))),(0,r.mdx)("tr",{parentName:"tbody"},(0,r.mdx)("td",{parentName:"tr",align:null},(0,r.mdx)("inlineCode",{parentName:"td"},"topological")),(0,r.mdx)("td",{parentName:"tr",align:null},(0,r.mdx)("inlineCode",{parentName:"td"},'["qux", "bar", "foo"]'))),(0,r.mdx)("tr",{parentName:"tbody"},(0,r.mdx)("td",{parentName:"tr",align:null},(0,r.mdx)("inlineCode",{parentName:"td"},"bfs")),(0,r.mdx)("td",{parentName:"tr",align:null},(0,r.mdx)("inlineCode",{parentName:"td"},'["qux", "foo", "bar"]'))))),(0,r.mdx)(c,{mdxType:"FbInternalOnly"},(0,r.mdx)("p",null,"This is verified by the test:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-starlark",metastring:"src=fbcode/buck2/app/buck2_build_api_tests/src/interpreter/transitive_set/tests.rs title=fbcode/buck2/app/buck2_build_api_tests/src/interpreter/transitive_set/tests.rs",src:"fbcode/buck2/app/buck2_build_api_tests/src/interpreter/transitive_set/tests.rs",title:"fbcode/buck2/app/buck2_build_api_tests/src/interpreter/transitive_set/tests.rs"},'# Test all orderings which show up in the table.\nassert_eq(list(set3.traverse()), ["qux", "foo", "bar"])\nassert_eq(list(set3.traverse(ordering = "preorder")), ["qux", "foo", "bar"])\nassert_eq(list(set3.traverse(ordering = "postorder")), ["foo", "bar", "qux"])\nassert_eq(list(set3.traverse(ordering = "topological")), ["qux", "bar", "foo"])\nassert_eq(list(set3.traverse(ordering = "bfs")), ["qux", "foo", "bar"])\n'))),(0,r.mdx)("h2",{id:"implementation-details"},"Implementation details"),(0,r.mdx)("h3",{id:"projection-evaluation"},"Projection evaluation"),(0,r.mdx)("p",null,"Projections are evaluated eagerly for each node of your transitive set. This means that if your projection throws an error, you'll find out when creating a set via ",(0,r.mdx)("inlineCode",{parentName:"p"},"ctx.actions.tset"),"."))}h.isMDXComponent=!0}}]);